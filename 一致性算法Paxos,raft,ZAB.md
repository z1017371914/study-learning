# 一致性算法

[toc]

## 面试问题

* 羊群问题和脑裂问题？
* 为什么大多数人都说zk是cp的，有说强一致的，又说顺序一致的，这里又说zab是最终一致的，希望后面阅读中能找到合适的答案！
* 

## 术语

### 拜占庭容错

> 拜占庭错误是莱斯利·兰伯特在《拜占庭将军问题》中提出的一个错误模型，描述了一个完全不可信的场景，除了存在故障行为，还存在恶意行为。顾名思义，拜占庭容错（Byzantine Fault Tolerance，BFT），就是指能容忍拜占庭错误了
>
> Pow pbft

### 非拜占庭

> 而非拜占庭容错，又叫故障容错（Crash Fault Tolerance，CFT），解决的是分布式系统中存在故障，但不存在恶意节点的共识问题，比如进程奔溃，服务器硬件故障等等。
>
> 二阶段提交协议（2PC）、TCC（Try-Confirm-Cancel）、Paxos 算法、ZAB 协议、Raft 算法、Gossip 协议、Quorum NWR 算法



![](https://tva1.sinaimg.cn/large/008i3skNgy1gsl214e3ygj30dt09paao.jpg)

## [PAXO算法](https://time.geekbang.org/column/article/201700)

> 三种角色: 提议者（Proposer）、接受者（Acceptor）、学习者（Learner）
>
> 主要基于二阶段提交，分为两个阶段，prepare阶段和Accept阶段
>
> 基于某一个值达成一致
>
> prepare阶段： 事务id
>
> accept阶段： （事务id,值）
>
> 根据提案编号的大小，接受者保证三个承诺，具体来说：
>
> 1. 如果准备请求的提案编号，小于等于接受者已经响应的准备请求的提案编号，那么接受者将承诺不响应这个准备请求； （未接受提案阶段-准备阶段）
> 2. 如果接受请求中的提案的提案编号，小于接受者已经响应的准备请求的提案编号，那么接受者将承诺不通过这个提案； （未接受提案阶段-接收阶段）
> 3. 如果接受者之前有通过提案，那么接受者将承诺，会在准备请求的响应中，包含已经通过的最大编号的提案信息。 （接受提案阶段-）

## Multi PAXO 算法

> Paxo 存在一些问题：
>
> 1. 如过多个提议者接受提案可能存在编号冲突
> 2. 产生大量的rpc请求
>
> 就是选举一个领导者



## Raft

### 领导者选举

> 三种角色：Raft 算法支持领导者（Leader）、跟随者（Follower）和候选人（Candidate） 3 种状态

* 跟随者：就相当于普通群众，默默地接收和处理来自领导者的消息，当等待领导者心跳信息超时的时候，就主动站出来，推荐自己当候选人。
* 候选人：候选人将向其他节点发送请求投票（RequestVote）RPC 消息，通知其他节点来投票，如果赢得了大多数选票，就晋升当领导者。
* 领导者：蛮不讲理的霸道总裁，一切以我为准，平常的主要工作内容就是 3 部分，处理写请求、管理日志复制和不断地发送心跳信息，通知其他节点“我是领导者，我还活着，你们现在不要发起新的选举，找个新领导者来替代我。

自己的话总结： 比如有三个节点，每个节点有个随机等待时间，假设A等待时间最短，那么A就向B和C 请求投票，如果在没有超时的时间内获得投票超过半数那么A就是leader,并不停的发送心跳，阻止篡权。

总结：

> Raft 算法本质：通过一切以领导者为准的方式，实现一系列值的共识和各节点日志的一致
> 服务节点状态：
> • 领导者（Leader）：处理写请求、管理日志复制、与跟随者间维持心跳服务
> • 跟随者（Follower）：接受和处理来自领导者的消息，当领导者节点故障时，推荐自己进行选举
> • 候选人（Candidate）：向其他跟随者节点发送请求投票 RPC 消息，通知投票，若获得大多数节点的投票，则成功竞选为领导者。
> 服务节点状态变更：
> • 跟随者 -> 候选人 -> 领导者
> • 领导者 -> 跟随者
> • 候选人 -> 跟随者
> Raft 算法通过任期、领导者心跳消息、随机选举超时时间、先来先服务的投票原则、大多数选票原则等，保证了一个任期只有一位领导，也极大地减少了选举失败的情况。具体的选举细节如下：
> • 节点间通讯方式：RPC 通讯，分为请求投票 RPC 和日志复制 RPC。投票 RPC 由候选人发起，通知其他阶段进行投票选举； 日志复制 RPC 由领导者发起，用于日志复制和维持心跳服务。
> • 领导者任期：与现实生活中领导者任期不同的是，这里的任期是指任期编号，而非任期时间。跟随者在等待领导者心跳信息超时后，推举自己为候选人时，会增加自己的任期号；如果一个服务器节点，发现自己的任期编号比其他节点小，那么它会更新自己的编号到较大的编号值。
> • 在 Raft 算法中约定，如果一个候选人或者领导者，发现自己的任期编号比其他节点小，那么它会立即恢复成跟随者状态
> • 如果一个节点接收到一个包含较小的任期编号值的请求，那么它会直接拒绝这个请求
> • 选举规则：
> • 领导者周期性地向所有跟随者发送心跳信息，维持自己的领导者状态
> • 跟随者在随机超时时间内没有收到领导者的心跳信息，则发起领导者选举，节点状态变更为候选人，进入选举阶段
> • 选举阶段，候选人收到超过半数以上的投票，节点状态变更为领导者，选举结束
> • 选举阶段，一个服务节点最多会对一个任期编号投出一张选票，按照“先来先服务”原则进行投票；若任期编号同，则按照“日志完整性”原则进行投票。（日志完整性是服务节点的最后一条日志项对应的任期编号值和索引号。一般情况下，任期编号值更大，索引号更大）。
> • 随机超时时间：
> • 跟随者等待领导者心跳信息超时的时间间隔，是随机的
> • 当没有候选人赢得过半票数，选举无效了，这时需要等待一个随机时间间隔，也就是说，等待选举超时的时间间隔，是随机的



### 日志复制

### 成员变更



